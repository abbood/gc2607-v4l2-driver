#!/bin/bash
# GC2607 Camera Driver - Post-Reboot Initialization
# Run this after every reboot to set up the camera

set -e

echo "========================================"
echo "  GC2607 Camera Initialization"
echo "========================================"
echo ""

# Check if permissions are set up
if ! groups | grep -q video; then
    echo "⚠️  First time setup needed!"
    echo ""
    echo "Run: sudo ./setup_permissions.sh"
    echo "Then log out and log back in."
    echo ""
    exit 1
fi

echo "Step 1: Loading kernel modules..."
sudo modprobe videodev
sudo modprobe v4l2-async
sudo modprobe ipu_bridge
sudo modprobe intel-ipu6
sudo modprobe intel-ipu6-isys
sleep 2

echo "Step 2: Loading GC2607 driver..."
cd /home/abbood/dev/camera-driver-dev/gc2607-v4l2-driver

# Unload if already loaded
if lsmod | grep -q gc2607; then
    echo "  Driver already loaded, reloading..."
    media-ctl -d /dev/media0 -l '"Intel IPU6 CSI2 0":1 -> "Intel IPU6 ISYS Capture 0":0[0]' 2>/dev/null || true
    sleep 1
    sudo modprobe -r intel-ipu6-isys 2>/dev/null || true
    sudo modprobe -r intel-ipu6 2>/dev/null || true
    sleep 1
    sudo modprobe intel-ipu6
    sudo modprobe intel-ipu6-isys
    sleep 1
fi

sudo insmod gc2607.ko
sleep 2

echo "Step 3: Configuring camera formats..."
media-ctl -d /dev/media0 -V '"Intel IPU6 CSI2 0":0 [fmt:SGRBG10_1X10/1920x1080]'
media-ctl -d /dev/media0 -V '"Intel IPU6 CSI2 0":1 [fmt:SGRBG10_1X10/1920x1080]'
v4l2-ctl -d /dev/video0 --set-fmt-video=width=1920,height=1080,pixelformat=BA10
media-ctl -d /dev/media0 -l '"Intel IPU6 CSI2 0":1 -> "Intel IPU6 ISYS Capture 0":0[1]'

echo "Step 4: Setting optimal exposure/gain..."
v4l2-ctl -d /dev/v4l-subdev6 --set-ctrl exposure=1335,analogue_gain=253

echo ""
echo "✅ Camera initialized successfully!"
echo ""
echo "Camera device: /dev/video0"
echo "Control device: /dev/v4l-subdev6"
echo ""
echo "Current settings:"
v4l2-ctl -d /dev/v4l-subdev6 --list-ctrls | grep -E "(exposure|gain)"
echo ""
echo "========================================"
echo "  Next Steps"
echo "========================================"
echo ""
echo "Option 1: Create Virtual RGB Camera for OBS/Meet"
echo "  ./create_virtual_camera.sh"
echo "  Then use /dev/video10 in OBS Studio"
echo ""
echo "Option 2: Quick Capture Test"
echo "  ./quick_capture.sh"
echo ""
echo "Option 3: Adjust Settings Live"
echo "  v4l2-ctl -d /dev/v4l-subdev6 --set-ctrl exposure=1200"
echo "  v4l2-ctl -d /dev/v4l-subdev6 --set-ctrl analogue_gain=240"
echo ""
echo "========================================"
echo ""
echo "Status: PHASE 7 COMPLETE ✅"
echo "  - Exposure/Gain controls working"
echo "  - White balance fixed (use view_raw_improved.py)"
echo "  - Optimal defaults: exposure=1335, gain=253"
echo "  - Ready for OBS Studio and video apps"
echo ""
